<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/ros-action-client/ros-action-client.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/ros-service/ros-service.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../underscore.html">

<dom-module id="pbd-new-action">
    <template>
        <style include="shared-styles"></style>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
                height: 100%;
            }

            .paper-material {
                margin-top: 5px;
            }

            a {
                color: #000;
                text-decoration: none;
            }

            .add {
                height: 25px;
                padding: 5px 5px;
                line-height: 14px;
                margin-bottom: 5px;
            }

            paper-input {
                width: 40%;
                display: inline-block;
            }

            paper-dropdown-menu {
                max-width: 100px;
                margin-left: 10px;
                margin-top: 0px;
                text-align: center;
            }

            .runstop {
                color: #fff;
                margin-left: 10px;
                height: 40px;
            }

            .run {
                background-color: var(--paper-green-500);
            }

            .stop {
                background-color: var(--paper-red-500);
            }

            .stepDiv {
                min-width: 550px;
                margin-bottom: 10px;
                /*overflow-y: auto;*/
                padding-left: 2px;
                padding-right: 2px;
                padding-bottom: 2px;
                display: inline-block;
            }

            #rviz {
                display: block;
                min-height: 500px;
            }

            fieldset>p {
                display: inline-block;
                margin-top: 5px;
            }

            fieldset iron-icon {
                display: inline-block;
                vertical-align: top;
                margin-top: 5px;
            }

            .delete {
                font-size: 80%;
                padding: 0;
                width: 5px;
                color: red;
                flex: 1;
            }

            .petit {
                font-size: 80%;
                margin: 0;
                margin-left: 5px;
                color: steelblue;
            }

            @media (min-width: 468px) {
                #layout {
                    height: 100%;
                }
                .content {
                    @apply(--layout-horizontal);
                    @apply(--layout-flex);
                }
                .stepDiv {
                    min-width: 500px;
                    max-height: 100%;
                    margin-bottom: 0px;
                    margin-right: 10px;
                }
                #rviz {
                    min-height: 350px;
                    max-width: 500px;
                    @apply(--layout-flex);
                }

                .button_not {
                    vertical-align: bottom;
                    padding-bottom: 9px;
                    padding-left: 6px;
                }
            }


            header {
                display: flex;
            }

            nav {
                font-size: 1.2em;
                text-align: center;
                flex: 1;
            }

            #actionName {
                width: 200px;
            }

            nav paper-button {
                border: 1px solid rgb(138, 125, 125);
                border-radius: 10px;
            }

            paper-dialog {
                border-radius: 5px;
            }

            paper-button.cancel {
                color: rgb(255, 68, 68);
            }

            #buttonDiv {
                float: right;
            }

            header {
                padding: 10px;
            }

            .important {
                width: 30px;
                height: 30px;
            }

            .listeWorldState {
                display: flex;
                border-bottom: 1px solid rgba(0, 0, 0, var(--light-divider-opacity));
            }

            .listeWorldState p {
                flex: 2;
                margin: 1px;
            }
        </style>
        <app-route route="{{route}}" pattern="/:id" data="{{routeData}}"></app-route>
        <ros-topic auto id="eventPub" msg-type="rapid_pbd_msgs/EditorEvent" topic="rapid_pbd/editor_events" ros="[[ros]]"></ros-topic>
        <ros-service auto id="createSrv" on-fail="_handleServiceError" on-response="_handleServiceResponse" name="/rapid_pbd/create_program"
            ros="[[ros]]" service-type="rapid_pbd_msgs/CreateProgram"></ros-service>
        <!-- PDDL -->
        <ros-topic auto last-message="{{pddlDomain}}" msg-type="rapid_pbd_msgs/PDDLDomain" topic="rapid_pbd/domain/{{domain_id}}"
            ros="[[ros]]"></ros-topic>
        <ros-topic auto last-message="{{domain_msg}}" msg-type="std_msgs/String" topic="rapid_pbd/pddl_domain" ros="[[ros]]"></ros-topic>

        <header>
            <paper-input id="actionName" label="Action name" value="{{actionName}}" auto-validate pattern="[a-zA-Z0-9_-]*" error-message="invalid characters"></paper-input>
            <nav>
                <!-- Action navigation buttons -->
                <paper-button class="petit" name="perception" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'perception')]]"
                    data-args="perception">
                    1. Perception
                </paper-button>
                <!-- <a href="#/program/{{action.program_id}}"> -->
                <paper-button name="demonstration" class="petit" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'demonstration')]]"
                    data-args="demonstration">
                    2. Demonstration
                </paper-button>
                <!-- </a> -->
                <paper-button class="petit" name="actionModel" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'actionModel')]]"
                    data-args="actionModel">
                    3. Conditions
                </paper-button>
            </nav>
            <div id="buttonDiv">

                <!-- <paper-radio-button class="button_not" id="button_show_robot">Show Robot</paper-radio-button> -->
                <paper-button raised class="clear" on-tap="_refreshViz">

                    <iron-icon icon="icons:refresh"> </iron-icon>
                </paper-button>
                <paper-button raised class="clear" on-click="saving">
                    <iron-icon icon="icons:save"> </iron-icon>
                    Save
                </paper-button>

                <paper-button raised class="clear" on-click="exiting">
                    <iron-icon icon="icons:close"> </iron-icon>
                </paper-button>
            </div>

            <paper-dialog modal id="saving">
                <h2>Save current action '[[actionName]]'?</h2>
                <p id="description">
                    Make sure the parameters and their types are correct. </p>
                <p>If action name changed, action will be closed on save.</p>
                <div>
                    <paper-button dialog-dismiss raised class="cancel">Cancel</paper-button>
                    <paper-button dialog-confirm raised on-tap="save">Save</paper-button>
                </div>
            </paper-dialog>

            <paper-dialog modal id="exiting">
                <h2>Quit current action?</h2>
                <p>All change not saved will be lost.</p>
                <div>
                    <paper-button dialog-dismiss raised class="cancel">Cancel</paper-button>
                    <paper-button dialog-confirm raised on-tap="quit">Quit</paper-button>
                </div>
            </paper-dialog>
        </header>


        <div id="layout" class="layout vertical">
            <!-- ***** DEMONSTRATION **** 2/3 -->
            <div class="content">
                <div id="stepContent" class="stepDiv">
                    <div id="demo" hidden$="[[!_displayNavStep(navStep,'demonstration')]]">
                        <template is="dom-if" if="[[_displayNavStep(navStep,'demonstration')]]">
                            <template is="dom-if" restamp if="[[!isAdminDomain(pddlDomain.name)]]">
                                <pbd-program-fake data-page="program" ros="[[ros]]" action="[[action]]" domain-id="[[domain_id]]" landmarks="[[action.landmarks]]"></pbd-program-fake>
                            </template>
                            <template is="dom-if" restamp if="[[isAdminDomain(pddlDomain.name)]]">
                                <pbd-program data-page="program" params="[[params]]" ros="[[ros]]" program-id="[[action.program_id]]"></pbd-program-fake>
                            </template>
                        </template>
                    </div>
                </div>
            </div>
            <div class="content">
                <div id="stepContent" class="stepDiv">
                    <!-- ***** BEFORE DEMO **** 1/3 -->
                    <div id="perception" hidden$="[[!_displayNavStep(navStep,'perception')]]">
                        <fieldset>
                            <legend>
                                Detected Elements
                            </legend>
                            <!-- <p>Verify all objects have been detected before proceeding.</p> -->
                            <p id="noObj">No objects detected
                                <br>
                            </p>

                            <template is="dom-repeat" items="{{action.params}}" as="item" index-as="paramIndex">
                                <div id="listeObjets">
                                    <paper-dropdown-menu no-label-float>
                                        <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{item.type.name}}">
                                            <template is="dom-repeat" items="[[_getTypes(item)]]" as="item2" index-as="typeIndex">
                                                <paper-item name="[[item2]]" on-tap="_updateType" data-args="[[item]]">[[item2]]</paper-item>
                                            </template>
                                        </paper-listbox>
                                    </paper-dropdown-menu>

                                    <font size="2pt" color="grey">([[item.name]])</font>
                                    <!-- <paper-icon-button class="clear" on-tap="moveUpParam" icon="arrow-upward"></paper-icon-button> -->
                                </div>
                            </template>

                            <paper-button id="detect" raised class="clear" on-tap="_maybeDetect" data-args="Precondition">
                                <iron-icon icon="icons:find-in-page"> </iron-icon>
                                Detect Elements
                            </paper-button>

                            <!-- <paper-button id="next" raised class="clear" on-tap="_selectNavStep" data-args="demonstration">
                Next
              </paper-button> -->
                        </fieldset>
                    </div>

                    <!-- ***** AFTER DEMO **** 3/3 -->
                    <div id="actionModel" hidden$="[[!_displayNavStep(navStep,'actionModel')]]">
                        <fieldset>
                            <legend>
                                Preconditions
                            </legend>

                            <paper-button id="detect1" raised class="clear" on-tap="_maybeDetect" data-args="Precondition">
                                <iron-icon icon="icons:find-in-page"> </iron-icon>
                                Detect Preconditions
                            </paper-button>
                            <br>
                            <br>

                            <template is="dom-repeat" items="{{action.preconditions}}" as="item" index-as="paramIndex">
                                <div class="listeWorldState">
                                    <p>
                                        [[_getParamTypeByName(item.arg1)]]
                                        <font size="2pt" color="grey">([[item.arg1.name]])</font>
                                    </p>
                                    <p>
                                        is [[_negate(item.negate)]] [[item.name]] [[_getParamTypeByName(item.arg2)]]
                                        <font size="2pt" color="grey">([[item.arg2.name]])</font>

                                    </p>
                                    <!-- <paper-icon-button icon="create" on-tap=""></paper-icon-button> -->
                                    <paper-icon-button class="delete" on-tap="deletePred" data-args="Precondition" icon="delete"></paper-icon-button>
                                </div>
                            </template>

                            <div>
                                <paper-dropdown-menu id="menu_instance1_precond" label="Element 1">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newPrecondition.arg1}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newPrecondition.arg1">
                                                [[item.name]]
                                            </paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-radio-button class="button_not" id="button_not_precond">not</paper-radio-button>
                                <paper-dropdown-menu id="menu_name_precond" label="Predicate">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newPrecondition.name}}">
                                        <template is="dom-repeat" items="[[domain.predicates]]">
                                            <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newPrecondition.predicate.name">is [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-dropdown-menu id="menu_instance2_precond" label="Element 2">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newPrecondition.arg2}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newPrecondition.arg2">
                                                [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-icon-button icon="icons:add-circle-outline" on-tap="addPredicate" data-args="Precondition">

                                </paper-icon-button>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>
                                Effects
                            </legend>

                            <paper-button id="detect2" raised class="clear" on-tap="_detect" data-args="Effect">
                                <iron-icon icon="icons:find-in-page"> </iron-icon>
                                Detect Effects
                            </paper-button>
                            <br>
                            <br>
                            <template is="dom-repeat" items="{{action.effects}}" as="item" index-as="paramIndex">
                                <div class="listeWorldState">
                                    <p>
                                        [[_getParamTypeByName(item.arg1)]]
                                        <font size="2pt" color="grey">([[item.arg1.name]])</font>

                                    </p>
                                    <p>
                                        is [[_negate(item.negate)]] [[item.name]] [[_getParamTypeByName(item.arg2)]]
                                        <font size="2pt" color="grey">([[item.arg2.name]])</font>

                                    </p>
                                    <!-- <paper-icon-button class="clear" on-tap="" icon="create"></paper-icon-button> -->
                                    <paper-icon-button class="delete" on-tap="deletePred" data-args="Precondition" icon="delete"></paper-icon-button>

                                </div>
                            </template>

                            <div>
                                <paper-dropdown-menu id="menu_instance1_effect" label="Element 1">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newEffect.arg1}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newEffect.arg1">
                                                [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-radio-button class="button_not" id="button_not_effect">not</paper-radio-button>
                                <paper-dropdown-menu id="menu_name_effect" label="Predicate">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newEffect.name}}">
                                        <template is="dom-repeat" items="[[domain.predicates]]">
                                            <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newEffect.predicate.name">is [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-dropdown-menu id="menu_instance2_effect" label="Element 2">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newEffect.arg2}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newEffect.arg2">
                                                [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-icon-button icon="icons:add-circle-outline" on-tap="addPredicate" data-args="Effect"></paper-icon-button>
                            </div>

                        </fieldset>
                        <center>
                            <br>
                            <paper-button class="clear" raised on-tap="_generateConditions">
                                <iron-icon icon="icons:lightbulb-outline"></iron-icon>
                                Confirm Conditions
                            </paper-button>
                        </center>
                    </div>
                </div>
                <ros-rviz id="rviz" ros="[[ros]]"></ros-rviz>
            </div>
        </div>
        <paper-dialog id="errorDialog" modal>
            <h2>Error running the program</h2>
            <p>[[error]]</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="errorNewPrecond">
            <h2>Error creating new precondition</h2>
            <p id="msgErrorNewPrecond" style="padding-top: 5px; padding-bottom: 5px;">An error has been encountered ...</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="errorNewEffect">
            <h2>Error creating new effect</h2>
            <p id="msgErrorNewEffect" style="padding-top: 5px; padding-bottom: 5px;">An error has been encountered ...</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="errorConditions">
            <h2>Error generating conditions</h2>
            <p id="msgErrorConditions" style="padding: 5px">An error has been encountered ...</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="confirmConditions">
            <h2>Confirm conditions</h2>
            <p id="msgConfirmConditions" style="padding: 5px">Action has been learned...</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="detectDialog" modal>
            <h2>Redetect elements? This will override existing objects.</h2>
            <div class="detectButtons">
                <paper-button class="clear" dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="_detect" class="delete" data-args="Precondition">Detect</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog modal id="loading">
            <p>
                <paper-spinner-lite active></paper-spinner-lite>
                Detecting objects on the table
            </p>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'pbd-new-action',
            properties: {
                navStep: {
                    type: String,
                    value: "perception"
                },
                action: Object,
                domain: Object,
                domain_id: String,
                domain_msg: {
                    type: Object,
                    value: function () {
                        return { data: false };
                    }
                },
                actionParams: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                params: Object,
                program_id_set: {
                    type: Object,
                    value: function () {
                        return { data: false };
                    }
                },
                program: {
                    type: Object,
                    observer: '_programChanged',
                },
                ros: Object,
                route: Object,
                isRunning: {
                    type: Object,
                    value: function () {
                        return { data: false };
                    }
                },
                pddlDomain: {
                    type: Object,
                    value: function () {
                        return { actions: [] };
                    }
                },
                newPrecondition: {
                    type: Object,
                    value: function () {
                        return {
                            arg1: Object,
                            name: '',
                            arg2: Object,
                            negate: false,
                        };
                    }
                },
                newEffect: {
                    type: Object,
                    value: function () {
                        return {
                            arg1: Object,
                            name: '',
                            arg2: Object,
                            negate: false,
                        };
                    }
                },
                actionName: String,
                showing: Object,
                actionDesc: String,
                genActionDesc: String,
            },

            observers: [
                'load(domain_id, params.*,domain_msg.data)',
                '_domainUpdated(pddlDomain.*)',
                '_actionUpdated(action.*)',
                '_checkClearPrecond(newPrecondition.name)',
                '_checkClearEffect(newEffect.name)',
                '_stepChanged(ros, action.*)',
                // '_predicatesChanged(action.preconditions.*,action.effects.*)',
                // '_paramsChanged(action.params.*)',
                // '_aparamsChanged(actionParams.*)',
                //'showRobot(button_show_robot)',
                //'_effectsChanged(action.effects.*)'

            ],
            _checkClearPrecond: function (nom_precond) {
                if (nom_precond == "clear" || nom_precond == "thin" || nom_precond == "flat") {
                    this.$.menu_instance2_precond.disabled = true;
                    this.$.menu_instance2_precond.value = undefined;
                    this.newPrecondition.arg2 = undefined;
                } else {
                    this.$.menu_instance2_precond.disabled = false;
                }
            },
            _checkClearEffect: function (nom_effect) {
                if (nom_effect == "clear" || nom_effect == "thin" || nom_effect == "flat") {
                    this.$.menu_instance2_effect.disabled = true;
                    this.$.menu_instance2_effect.value = undefined;
                    this.newEffect.arg2 = undefined;
                } else {
                    this.$.menu_instance2_effect.disabled = false;
                }
            },
            // _paramsChanged: function (params) {
            //   // call generate params as soon as predicates change
            //   // if (this.action.params.length == 0)
            //   //   this.action.params = this.action.params.slice();
            //   console.debug("_paramsChanged:");
            //   console.debug("action.params changed to ", params.value);
            //   console.debug("actionParams is ", this.action.params);
            //   if (this.action.params.length == 0) {
            //     this.action.params = this.action.params;//.slice();
            //     //this.reevaluateArray('actionParams', this.action.params.slice());
            //   }
            // },
            // _aparamsChanged: function (params) {
            //   // call generate params as soon as predicates change
            //   console.debug("_aparamsChanged:");
            //   console.debug("action.Params is ", this.action.params);
            //   console.debug("actionParams changed to ", params.value);
            //   if (this.action.params.length == 0) {
            //     this.action.params = this.action.params;//.slice();
            //     //this.reevaluateArray('actionParams', this.action.params.slice());
            //   }
            // },
            _predicatesChanged: function (preCs, effs) {
                // call generate params as soon as predicates change
                this._generateParams();
            },
            _effectsChanged: function (effs) {
                // call generate conditions as soon as effects change
                this._generateConditions();
            },
            _actionUpdated: function (action) {
                if (action && action.base && action.base.name != '') {
                    this.actionName = action.base.name;
                }
            },
            load: function (db_id, paramsChangeRecord, currDomainId) {

                if (!this.program_id_set) {
                    this._startDemo();
                    this.navStep = "perception"
                    //return;
                }
                if (!this.domain_id && currDomainId) {
                    console.log("set domain_id to: ", currDomainId);
                    this.domain_id = currDomainId;
                    // console.log("set actionParams from : ", this.action.params);
                    // for (var i = 0; i < this.action.params.length; ++i) {
                    //   this.action.params.push(this.action.params[i]);
                    // }
                    console.log("to : ", this.action.params);
                }
                if (!this.params.robot) {
                    return;
                }
                var depthCloudFrameId = '';
                if (this.params.robot === "pr2") {
                    depthCloudFrameId = '/head_mount_kinect_rgb_optical_frame';
                } else if (this.params.robot === "fetch") {
                    depthCloudFrameId = '/head_camera_rgb_optical_frame';
                } else if (this.params.robot === "baxter") {
                    depthCloudFrameId = '/camera_rgb_optical_frame';
                } else {
                    console.error('Unknown robot type', this.params.robot);
                }

                var fixedFrame = '';
                if (this.params.robot === "pr2" || this.params.robot === "fetch") {
                    fixedFrame = '/base_link';
                } else if (this.params.robot === "baxter") {
                    fixedFrame = '/base';
                } else {
                    console.error('Unknown robot type', this.params.robot);
                }
                if (this.action) {
                    db_id = this.action.program_id;
                }
                var config = {
                    globalOptions: {
                        background: '#113344',
                        colladaLoader: 'collada2',
                        colladaServer: window.location.protocol + '//' + window.location.hostname + ':8001/',
                        fixedFrame: fixedFrame,
                        videoServer: window.location.protocol + '//' + window.location.hostname + ':9998',
                        url: 'ws://' + window.location.hostname + ':9090'
                    },
                    displays: [
                        {
                            //   isShown: false,
                            //   name: 'Grid',
                            //   type: 'grid',
                            //   options: {
                            //     cellSize: 1,
                            //     color: '#cccccc',
                            //     numCells: 20,
                            //   },
                            // }, {
                            //   isShown: false,
                            //   name: 'Program robot model',
                            //   type: 'markerArray',
                            //   options: {
                            //     topic: '/rapid_pbd/robot/' + this.action.program_id,
                            //   },
                            // }, {
                            isShown: true,
                            name: 'Surface segmentation',
                            type: 'markerArray',
                            options: {
                                topic: '/rapid_pbd/surface_segmentation/' + this.action.program_id,
                            },
                        }, {
                            //   isShown: true,
                            //   name: 'Surface segmentation',
                            //   type: 'markers',
                            //   options: {
                            //     topic: '/rapid_pbd/surface_seg/visualization/'// + db_id,
                            //   },
                            // }, { 

                            isShown: true,
                            name: 'Scene',
                            type: 'pointCloud2',
                            options: {
                                size: 0.01,
                                topic: '/rapid_pbd/scene/' + this.action.program_id,
                            },
                            // }, {
                            //   isShown: false,
                            //   name: 'Current robot model',
                            //   type: 'urdf',
                            //   options: {
                            //     param: 'robot_description',
                            //     tfPrefix: ''
                            //   },
                            // }, {
                            // isShown: false,
                            // name: 'Current surface segmentation',
                            // type: 'markerArray',
                            // options: {
                            //   topic: '/rapid_pbd/runtime_segmentation',
                            // },
                            // }, {
                            //   isShown: false,
                            //   name: 'Current depth cloud',
                            //   type: 'depthCloud',
                            //   options: {
                            //     topic: 'depthcloud_encoded',
                            //     frameId: depthCloudFrameId
                            //   },
                        },
                    ],
                    sidebarOpened: false,
                };
                if (this.$.rviz /*&& !this._displayNavStep(this.navStep, 'demonstration')*/) {
                    this.$.rviz.config = config;
                } else {
                    console.info('rviz not ready');
                }
            },

            _updatePredicate: function (evt) {
                var args = evt.target.getAttribute('data-args');
                this.set(args, evt.target.name);
                console.debug(args, ' is ', this.newPrecondition);
            },
            checkPredicate: function (mode, _new) {
                var newPredicate = _new;
                var valide = true;
                var index = 0;
                // msgErreur explains why the precond isn't valid
                var msgErreur = "";

                if (mode == "precondition") {
                    var liste = this.action.preconditions;
                    // Check if items are well selected
                    if (this.$.menu_instance1_precond.value == undefined
                        || this.$.menu_name_precond.value == undefined
                        || ((this.$.menu_name_precond.value == "is on"
                            || this.$.menu_name_precond.value == "is stackable")
                            && this.$.menu_instance2_precond.value == undefined)) {
                        valide = false;
                        msgErreur = "Complete your new predicate before adding it";
                    }
                } else {
                    var liste = this.action.effects;
                    // Check if items are well selected
                    if (this.$.menu_instance1_effect.value == undefined
                        || this.$.menu_name_effect.value == undefined
                        || ((this.$.menu_name_precond.value == "is on"
                            || this.$.menu_name_precond.value == "is stackable")
                            && this.$.menu_instance2_effect.value == undefined)) {
                        valide = false;
                        msgErreur = "Complete your new predicate before adding it";
                    }
                }

                if (valide) {
                    // Without negation
                    if (!newPredicate.negate) {
                        // To comment when you want to test, else it's impossible to test on simulation
                        console.debug('test valide ' + newPredicate.arg1.type.name);
                        console.debug('test valide ' + newPredicate.name);

                        if (newPredicate.arg1.type.name == "position" && newPredicate.name == "on") {
                            valide = false;
                            msgErreur = "A position can't be on something else"
                        }
                        else if (newPredicate.name == "on" && newPredicate.arg1.name == newPredicate.arg2.name) {
                            valide = false;
                            msgErreur = "An element can't be set on himself";
                        }

                        while (valide && index < liste.length) {
                            if (newPredicate.name == liste[index].name
                                && (newPredicate.name == "clear"
                                    || newPredicate.name == "flat"
                                    || newPredicate.name == "thin")
                                && newPredicate.arg1.name == liste[index].arg1.name) {
                                valide = false;
                                msgErreur = "This " + mode + " exists already";
                            }
                            else if (newPredicate.name == liste[index].name && newPredicate.arg1.name == liste[index].arg1.name && newPredicate.arg2.name == liste[index].arg2.name) {
                                valide = false;
                                msgErreur = "This " + mode + " exists already";
                            }
                            else if (newPredicate.name == "on" && liste[index].name == "on") {
                                if (newPredicate.arg2.name == liste[index].arg2.name) {
                                    valide = false;
                                    msgErreur = "You can't place two objects on one position, see :<br><strong>" + liste[index].arg1.name + liste[index].name + liste[index].arg2.name + "</strong>";
                                } else if (newPredicate.arg1.name == liste[index].arg1.name) {
                                    valide = false;
                                    msgErreur = "One object can't be on two positions, see :<br><strong>" + liste[index].arg1.name + " is " + liste[index].name + " " + liste[index].arg2.name + "</strong>";
                                }
                            }
                            else if (newPredicate.name == "clear" && (liste[index].name == "on" && liste[index].arg2.name == newPredicate.arg1.name)) {
                                valide = false;
                                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + "is " + liste[index].name + " " + liste[index].arg2.name + "</strong>";
                            }
                            else if (liste[index].name == "clear" && (newPredicate.name == "on" && newPredicate.arg2.name == liste[index].arg1.name)) {
                                valide = false;
                                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + " is " + liste[index].name + "</strong>";
                            }
                            index++;
                        }
                        // With negation
                    } else {

                    }
                }
                return { valid: valide, msg: msgErreur };
            },
            addPredicate: function (evt) {
                var condition = evt.target.getAttribute('data-args');
                if (condition == "Precondition") {
                    // Check if the NOT-button is checked or no and update it
                    this.newPrecondition.negate = this.$.button_not_precond.checked;
                    this.$.button_not_precond.checked = false;

                    var check = this.checkPredicate("precondition", this.newPrecondition);
                    if (check.valid) {
                        // We recreate the this.newPrecondition object, else it's passed by reference and it causes problems
                        this.action.preconditions.push({ arg1: this.newPrecondition.arg1, name: this.newPrecondition.name, arg2: this.newPrecondition.arg2, negate: this.newPrecondition.negate });
                        this.reevaluateArray('action.preconditions', this.action.preconditions);
                        this.logActivity('2.3.2,add precondition:' + this.newPrecondition.arg1.name + ' ' + this.newPrecondition.name);
                    } else {
                        this.$.msgErrorNewPrecond.innerHTML = check.msg;
                        this.$.errorNewPrecond.open();
                    }
                } else if (condition == "Effect") {
                    // Check if the NOT-button is checked or no and update it
                    this.newEffect.negate = this.$.button_not_effect.checked;
                    this.$.button_not_effect.checked = false;

                    var check = this.checkPredicate("effect", this.newEffect);
                    if (check.valid) {
                        this.action.effects.push({ arg1: this.newEffect.arg1, name: this.newEffect.name, arg2: this.newEffect.arg2, negate: this.newEffect.negate });
                        this.reevaluateArray('action.effects', this.action.effects);
                        this.logActivity('2.3.2,add effect:' + this.newEffect.arg1.name + ' ' + this.newEffect.name);
                    } else {
                        this.$.msgErrorNewEffect.innerHTML = check.msg;
                        this.$.errorNewEffect.open();
                    }
                }
                // this._generateParams();
            },
            // showRobot: function (button) {
            //   this.showRobotModel = this.$.button_show_robot.checked;
            // },
            deletePred: function (evt) {
                var item = evt.model.item;
                console.debug('deletePred', item);
                var index = -1;
                index = this.action.preconditions.indexOf(item);
                if (index != -1) {
                    this.splice('action.preconditions', index, 1);
                    this.reevaluateArray('action.preconditions', this.action.preconditions);

                    this.logActivity('2.3.1,delete precondition:' + item.arg1.name + ' ' + item.name);

                } else {
                    index = this.action.effects.indexOf(item);
                    if (index != -1) {
                        this.splice('action.effects', index, 1);
                        this.reevaluateArray('action.effects', this.action.effects);

                        this.logActivity('2.3.1,delete effect:' + item.arg1.name + ' ' + item.name);

                    }
                }
                // this._generateParams();
            },

            reevaluateArray: function (name, property) {
                var conds = property;
                this.set(name, []);
                this.set(name, conds);
                console.debug('reevaluateArray: ', name, ' to ', conds);
            },
            _nameValid: function (name) {
                for (var i = 0; i < this.domain.actions.length; ++i) {
                    if (this.domain.actions[i].name == name) return false;
                }
                return true;
            },
            save: function () {
                if (this.actionName != this.action.name && !this._nameValid(this.actionName)) {
                    alert(this.actionName + ' already exists. Please choose a different name.');
                } else {
                    console.debug('Saving params ', this.action.params);
                    //this.reevaluateArray('action.params', this.action.params.slice());
                    //this.action.params = this.action.params.slice();
                    var msg = {
                        type: 'update pddl action',
                        domain_id: this.domain_id,
                        action_name: this.actionName,
                        pddl_action: this.action
                    };

                    console.debug('Saving ', this.domain, " with name ", this.domain_id);
                    console.debug('Saving ', this.action, " with name ", this.actionName);
                    this.$.eventPub.publish(msg);
                    this.logActivity('2.0.2,save action: ' + this.action.name);
                    if (this.actionName != this.action.name) {
                        this.logActivity('2.0.4,renamed action to ' + this.actionName);
                        this.quit();
                    }
                }
            },

            saving: function (evt) {
                this.actionDesc = this._getAction(this.action);
                this.genActionDesc = this._getGeneralisedAction(this.action);
                this.$.saving.open();
            },
            exiting: function (evt) {
                this.$.exiting.open();
            },
            quit: function (evt) {
                this.logActivity('2.0.3,quit action: ' + this.action.name);
                this.fire('quit');
            },

            _updateDomain: function (evt) {
                var msg = {
                    type: 'update pddl domain',
                    domain_id: this.domain_id,
                    pddl_domain: this.domain
                };
                console.debug('updateDomain: ', this.domain);
                this.$.eventPub.publish(msg);
            },

            _stepChanged(ros, action) {
                // Load robot visualization
                // need this to start publishing program_id
                if (!ros || !this.action.program_id) {
                    return;
                }
                var msg = {
                    type: 'view step',
                    program_info: {
                        db_id: this.action.program_id
                    },
                    step_num: 0
                };
                this.$.eventPub.publish(msg);
            },
            _domainUpdated: function (changedDomain) {
                if (changedDomain.value) {
                    this.$.loading.close();
                    this.domain = changedDomain.value;
                    //updating the current action
                    var j = 0;
                    while (j < this.domain.actions.length && this.domain.actions[j].name != this.action.name) {
                        j++;
                    }
                    if (j != this.domain.actions.length) {
                        this.action = this.domain.actions[j];
                    }
                    //show if no objects have been detected
                    var i = 0;
                    while (i < this.action.params.length
                        && this.action.params[i].type.name == "position") {
                        i++;
                    }
                    if (i != this.action.params.length) {
                        this.$.noObj.style.display = "none";
                    }
                }
            },

            _handleServiceResponse(evt) {
                var id = evt.detail.db_id;
                this.action.program_id = id;
                console.debug('_handleServResponse: action assigned program id: ', this.action.program_id);
                this._updateDomain();
            },
            _handleServiceError: function (evt) {
                console.error(evt.detail);
            },
            _startDemo: function (evt) {
                if (!isAdminDomain(pddlDomain.name)) {
                    console.debug("_startDemo: fake program created, no program-id");
                    return;
                }
                console.debug("_startDemo: admin domain, create program and assign program-id");
                if (this.action.program_id && this.action.program_id.length > 0) {
                    console.debug('Program already exists ... ', this.action.program_id);
                } else {
                    this.program_id_set = true;
                    console.debug('New Program being created ... ');
                    var name = 'Program for: ' + this.actionName;
                    var request = {
                        name: name,
                    };
                    this.$.createSrv.call(request);
                }
            },
            _refreshViz: function (evt) {
                state = this.navStep == "actionModel" ? "Effect" : "Precondition";
                console.debug('  _refreshViz: state: ', state);
                var msg = {
                    type: 'assign surface objects',
                    program_info: {
                        db_id: this.action.program_id
                    },
                    step_num: 0,
                    pddl_action: this.action,
                    state_name: state
                };

                console.debug('  _refreshViz: ', this.action);
                this.logActivity('2.0.1,refresh view');
                this.$.eventPub.publish(msg);
                this.load();
            },
            _maybeDetect: function (evt) {
                if (this.action.params.length > 0)
                    this.$.detectDialog.open();
                else
                    this._detect(evt);
            },
            _detect: function (evt) {
                if (!this.ros) {
                    console.error('Unable to call detection right now.');
                    return;
                }
                var state = evt.target.getAttribute('data-args');
                console.log("_detect for domain: ", this.domain_id);
                var msg = {
                    type: 'detect action conditions',
                    domain_id: this.domain_id,
                    action_name: this.action.name,
                    state_name: state
                };
                this.$.loading.open();
                this.$.eventPub.publish(msg);

                this.logActivity('2.1.1,detect action conditions: ' + state);

            },
            removeDuplicates: function (a) {
                uniqueArray = a.filter(function (item, pos) {
                    return a.indexOf(item) == pos;
                });
            },
            _getAction: function (a) {
                // returns action description with instantiated params:
                var text = this.actionName + "(";
                var paramList = "";
                for (var i = 0; i < this.action.params.length; ++i) {
                    paramList += this.action.params[i].name + ", ";
                }
                return text + paramList.slice(0, -2) + ")";
            },
            _getGeneralisedAction: function (a) {
                // returns action operator description with types:
                var text = this.actionName + "(";
                var paramList = "";
                for (var i = 0; i < Object.keys(this.action.params).length; ++i) {
                    paramList += this.action.params[i].type.name.toUpperCase() + ", ";
                }
                return text + paramList.slice(0, -2) + ")";
            },
            _getParamTypeByName: function (obj) {
                // console.debug('_getParamTypeByName: ', item);

                for (var i = 0; i < this.action.params.length; ++i) {
                    if (this.action.params[i] && obj && this.action.params[i].name == obj.name)
                        return this.action.params[i].type.name;
                }
                return "";

            },

            _getTypes: function (item) {
                var names = [];
                // console.debug('_getTypes: ', item);
                if (this.domain.types) {
                    for (var i = 0; i < this.domain.types.length; ++i) {
                        names.push(this.domain.types[i].name);
                    }
                }
                // console.debug('_getTypes: ', names);
                return (names);
            },

            _updateType: function (evt) {
                this.reevaluateArray('action.params', this.action.params);
                console.debug("_updateType: ", evt.target);
                this.logActivity('2.1.2, change type to: ' + evt.target.name);
            },
            moveUpParam: function (evt) {
                //change order of params
                var item = evt.model.item;
                // get index of selected param
                var index = -1;
                // var parms = this.action.params;
                fromIndex = this.action.params.indexOf(item);
                console.debug('moveUpParam:', this.action.params, " ", fromIndex);
                if (fromIndex > 0) {
                    var element = this.action.params[fromIndex];
                    this.action.params.splice(fromIndex, 1);
                    console.debug("types of item vs element : ", typeof item, typeof element);
                    var toIndex = fromIndex - 1;
                    console.debug('moveUpParam:', "to index: ", toIndex);
                    this.action.params.splice(toIndex, 0, element);
                    console.debug("splicing...");
                    //console.debug(typeof parms, typeof this.action.params);
                    // this.action.params = parms;
                    this.reevaluateArray('action.params', this.action.params);
                    this.logActivity('2.1.3,move up parameter: ' + item.name + ' to ', toIndex);
                }
                console.debug('moveUpParam: final action.params is', this.action.params);
            },
            _generateParams: function () {
                var predList = this.action.preconditions.concat(this.action.effects)
                var parms = this._getParams(predList);
                console.debug(typeof parms, typeof this.action.params);
                console.debug('parms:', parms);
                this.action.params = parms;
                this.reevaluateArray('action.params', parms);
            },
            _findByName: function (name, list) {
                for (var i = 0; i < list.length; ++i) {
                    if (list[i].name == name)
                        return list[i];
                }
            },
            _getParams: function (predList) {
                // returns parameters from a list of predicates e.g. preconditions
                var params = [];
                if (this.action.params) {
                    //params = [];
                    const nameList = new Set([]);
                    for (var i = 0; i < predList.length; ++i) {
                        var arg1name = predList[i].arg1.name;
                        if (arg1name != '' && !nameList.has(arg1name)) {
                            params.push(this._findByName(arg1name, this.action.params));
                            nameList.add(arg1name);
                        }
                        if (predList[i].arg2 && predList[i].arg2.name != '' && !nameList.has(predList[i].arg2.name)) {
                            params.push(this._findByName(predList[i].arg2.name, this.action.params));
                            nameList.add(predList[i].arg2.name);
                        }
                    }
                }
                return params;
            },
            _generateConditions: function () {
                // check preconditions and effects are there
                if (this.action.preconditions.length == 0) {
                    this.$.msgErrorConditions.innerHTML = "No preconditions were specified. Please add them.";
                    this.$.errorConditions.open();
                } else if (this.action.effects.length == 0) {
                    this.$.msgErrorConditions.innerHTML = "No effects were specified. Please add them.";
                    this.$.errorConditions.open();
                }
                // If they are there then you can generate the conditions
                else {
                    this._getPredicateDiff(this.action.preconditions, this.action.effects);
                    //this._addNegations(this.action.preconditions, this.action.effects);
                    this.reevaluateArray('action.preconditions', this.action.preconditions);
                    this.reevaluateArray('action.effects', this.action.effects);
                    this._generateParams();
                    this.actionDesc = this._getAction(this.action);
                    this.genActionDesc = this._getGeneralisedAction(this.action);

                    var text = "Robot learned generalised action with types: <br><b>" + this.genActionDesc;
                    text += "</b> <br><br> Demonstrated action: <br> <b>" + this.actionDesc;
                    console.log("_generateConditions: ", text);
                    this.$.msgConfirmConditions.innerHTML = text;
                    this.$.confirmConditions.open();
                    this.logActivity('2.3.3,confirm conditions');

                }
            },
            _getPredicateDiff: function (list1, list2) {
                // removes predicates which are in both lists
                for (var i = 0; i < list1.length; ++i) {
                    for (var j = 0; j < list2.length; ++j) {
                        if (this._samePredicate(list1[i], list2[j])) {
                            list1.splice(i, 1);
                            list2.splice(j, 1);
                            i--;
                            break;
                        }
                    }
                }
                this._addNegations(list1, list2);
                return [list1, list2];
            },
            _addNegations: function (pre, eff) {
                // add negations in eff for is_on and is_clear in pre
                for (var i = 0; i < eff.length; ++i) {
                    let predic = Object.assign({}, eff[i]);
                    if (predic.name == "on" && !predic.negate) {
                        // check pre's "on" predicates and negate them
                        for (var p = 0; p < pre.length; ++p) {
                            if (pre[p].name == "on") {
                                let notOnPred = Object.assign({}, pre[p]);
                                notOnPred.negate = true;

                                // check if the clear predicate already exists, if yes then dont add
                                // var notOnExists = false;
                                // for (var k = 0; k < eff.length; ++k) {
                                //     if (this._samePredicate(clearPred, eff[j]))
                                //         notOnExists = true;
                                // }
                                // if (!notOnExists)
                                // eff.push(notOnPred);
                            }
                        }
                        // add a predicate that the target position is not clear
                        var clearPred = predic;
                        clearPred.arg1 = predic.arg2;
                        clearPred.arg2 = undefined;
                        clearPred.negate = true;
                        clearPred.name = "clear";
                    }
                }
                // check if the clear predicate already exists, if yes then dont add
                var clearExists = false;
                for (var j = 0; j < eff.length; ++j) {
                    if (this._samePredicate(clearPred, eff[j]))
                        clearExists = true;
                }
                if (!clearExists)
                    eff.push(clearPred);
                return eff;

            },
            _samePredicate: function (pred1, pred2) {
                if (pred1.name != pred2.name) {
                    //console.debug("_samePredicate: name ", pred1, pred2);
                    return false;
                }
                if (pred1.arg1.name != pred2.arg1.name) {
                    //console.debug("_samePredicate: arg1 ", pred1, pred2);
                    return false;
                }
                if (pred1.negate != pred2.negate) {
                    //console.debug("_samePredicate: negate ", pred1, pred2);
                    return false;
                }
                if (pred1.arg2 && pred2.arg2 && pred1.arg2.name != pred2.arg2.name) {
                    //console.debug("_samePredicate: arg2 ", pred1, pred2);
                    return false;
                }
                return true;
            },
            sortByName: function (arr) {
                arr.sort(function (a, b) {
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                });
                return arr;
            },
            _displayNavStep: function (navStep, name) {
                return (navStep == name);
            },
            _selectNavStep: function (evt) {
                this.navStep = evt.target.getAttribute('data-args');
                this.save();
                this.logActivity('switch to: ' + this.navStep);
            },
            _negate: function (neg) {
                if (neg) return 'not ';
                else return '';
            },
            isAdminDomain: function (name) {
                if (name == "Domain1")
                    return true;
                return false;
            },

            logActivity: function (activity) {
                var now = new Date();
                var currentMenu = 'new-action/' + this.navStep + ':' + this.action.name;
                console.debug('[ACTIVITY-LOG]', now.toLocaleString(), ',',
                    currentMenu, ',', activity);
                var msg = {
                    type: 'log activity',
                    domain_id: this.domain_id,
                    domain_name: '',
                    action_name: currentMenu,
                    state_name: activity // use state_name as log description text
                };
                this.$.eventPub.publish(msg);
            }
        });
    </script>