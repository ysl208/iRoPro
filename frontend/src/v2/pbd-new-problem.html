<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/ros-action-client/ros-action-client.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/ros-service/ros-service.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../underscore.html">

<dom-module id="pbd-new-problem">
  <template>
    <style include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      .paper-material {
        margin-top: 5px;
      }

      a {
        color: #000;
        text-decoration: none;
      }

      .add {
        height: 25px;
        padding: 5px 5px;
        line-height: 14px;
        margin-bottom: 5px;
      }

      paper-input {
        width: 40%;
        display: inline-block;
      }

      paper-dropdown-menu {
        max-width: 100px;
        margin-left: 10px;
        margin-top: 0px;
      }

      .stepDiv {
        min-width: 350px;
        margin-bottom: 10px;
        /*overflow-y: auto;*/
        padding-left: 2px;
        padding-right: 2px;
        padding-bottom: 2px;
        display: inline-block;
      }

      #rviz {
        display: block;
        height: 500px;
      }

      fieldset>p {
        display: inline-block;
      }

      fieldset iron-icon {
        display: inline-block;
        vertical-align: top;
        margin-top: 5px;
      }

      .delete {
        font-size: 80%;
        padding: 0;
        width: 5px;
        color: black;
      }

      .petit {
        font-size: 80%;
        margin: 0;
        margin-left: 5px;
        color: steelblue;
      }

      @media (min-width: 768px) {
        #layout {
          height: 100%;
        }
        .content {
          @apply(--layout-horizontal);
          @apply(--layout-flex);
        }
        .stepDiv {
          width: 350px;
          max-height: 100%;
          margin-bottom: 0px;
          margin-right: 10px;
          /*padding: 2%;*/
        }
        #rviz {
          height: 350px;
          width: 350px;
          @apply(--layout-flex);
        }
        .button_not {
          vertical-align: bottom;
          padding-bottom: 9px;
          padding-left: 6px;
        }
      }

      header {
        display: flex;
      }

      nav {
        font-size: 1.2em;
        text-align: center;
        flex: 1;
      }

      #problemName {
        width: 200px;
      }

      nav paper-button {
        border: 1px solid rgb(138, 125, 125);
        border-radius: 10px;
      }

      paper-dialog {
        border-radius: 5px;
      }

      paper-button.cancel {
        color: rgb(255, 68, 68);
      }

      #buttonDiv {
        float: right;
      }

      header {
        padding: 10px;
      }

      .important {
        width: 32px;
        height: 32px;
      }

      .listeWorldState {
        display: flex;
        border-bottom: 1px solid rgba(0, 0, 0, var(--light-divider-opacity));
      }

      .listeWorldState p {
        flex: 2;
        margin: 3px;
      }
    </style>
    <app-route route="{{route}}" pattern="/:id" data="{{routeData}}"></app-route>
    <ros-topic auto id="eventPub" msg-type="rapid_pbd_msgs/EditorEvent" topic="rapid_pbd/editor_events" ros="[[ros]]"></ros-topic>
    <!-- PDDL -->
    <ros-topic auto last-message="{{pddlDomain}}" msg-type="rapid_pbd_msgs/PDDLDomain" topic="rapid_pbd/pddl_domain" ros="[[ros]]"></ros-topic>
    <ros-topic auto last-message="{{domainList}}" msg-type="rapid_pbd_msgs/PDDLDomainInfoList" topic="rapid_pbd/domain_list"
      ros="[[ros]]"></ros-topic>


    <header>
      <paper-input id="problemName" label="Problem name" value="{{problemName}}" auto-validate pattern="[a-zA-Z0-9_-]*" error-message="invalid characters"></paper-input>
      <nav>
        <!-- Action navigation buttons -->
        <paper-button class="petit" name="perception" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'perception')]]"
          data-args="perception">
          1. Initial State
        </paper-button>
        <paper-button name="problemModel" class="petit" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'problemModel')]]"
          data-args="problemModel">
          2. Goal State
        </paper-button>
        <paper-button class="petit" name="generatedPlan" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'generatedPlan')]]"
          data-args="generatedPlan">
          3. Generated Plan
        </paper-button>
      </nav>
      <div id="buttonDiv">
        <paper-button raised on-click="exiting">
          <paper-icon-button id="quit" raised class="important" icon="icons:close" alt="quit"></paper-icon-button>
        </paper-button>
        <paper-button raised on-click="saving">
          Save
          <paper-icon-button id="save" raised class="important" icon="icons:save" alt="save"></paper-icon-button>
        </paper-button>

      </div>

      <paper-dialog modal id="saving">
        <h2>Save current problem ?</h2>
        <div>
          <paper-button dialog-dismiss raised class="cancel">Cancel</paper-button>
          <paper-button dialog-confirm raised on-tap="save">Save</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog modal id="exiting">
        <h2>Quit current problem ?</h2>
        <p>All change not saved will be lost.</p>
        <div>
          <paper-button dialog-dismiss raised class="cancel">Cancel</paper-button>
          <paper-button dialog-confirm raised on-tap="quit">Quit</paper-button>
        </div>
      </paper-dialog>
    </header>

    <div id="layout" class="layout vertical">

      <div class="content">
        <div id="stepContent" class="stepDiv">
          <!-- ***** Initial State **** 1/3 -->
          <div id="perception" hidden$="[[!_displayNavStep(navStep,'perception')]]">
            <fieldset>
              <legend>
                Detected World Instances
              </legend>
              <p>Verify all objects have been detected before proceeding.</p>
              <p id="noObj">No objects detected</p>
              <template is="dom-repeat" items="{{sortByName(problem.objects)}}" as="item" index-as="paramIndex">
                <tr>
                  <div id="listeObjet">
                    <td>
                      <paper-icon-button icon="check"></paper-icon-button>
                    </td>
                    <td>[[item.name]]</td>
                    <td>
                      <paper-dropdown-menu>
                        <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{item.type.name}}">
                          <template is="dom-repeat" items="[[_getTypes(item)]]" as="item2" index-as="typeIndex">
                            <paper-item name="[[item2]]" on-tap="_updateType" data-args="[[item]]">[[item2]]</paper-item>
                          </template>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </td>
                  </div>
                </tr>
              </template>
              <paper-button id="detect" raised class="clear" on-tap="_detect" data-args="initial">
                Detect World Objects
              </paper-button>
            </fieldset>

            <fieldset>
              <legend>
                Initial States
              </legend>
              <template is="dom-repeat" items="{{problem.initial_states}}" as="item" index-as="objectIndex">
                <div class="listeWorldState">
                  [[item.arg1.name]] is [[_negate(item.negate)]] [[item.name]] [[item.arg2.name]]
                  <paper-button class="delete" on-tap="deletePred" data-args="InitialState">
                    <paper-icon-button icon="delete"></paper-icon-button>
                  </paper-button>
                </div>
              </template>

              <div>
                <paper-dropdown-menu id="menu_instance1_precond" label="Instance 1">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.arg1}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newInitialState.arg1">
                        [[item.name]]
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-radio-button class="button_not" id="button_not_precond">not</paper-radio-button>
                <paper-dropdown-menu id="menu_name_precond" label="Predicate">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.name}}">
                    <template is="dom-repeat" items="[[domain.predicates]]">
                      <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newInitialState.predicate.name">is [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="menu_instance2_precond" label="Instance 2">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.arg2}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newInitialState.arg2">
                        [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
              <br>
              <paper-button noink class="petit" on-click="addPredicate" data-args="InitialState">+ add new predicate</paper-button>

              <paper-button id="next" raised class="clear" on-tap="_selectNavStep" data-args="problemModel">
                Next
              </paper-button>
            </fieldset>
          </div>

          <!-- ***** Goal States **** 2/3 -->
          <div id="problemModel" hidden$="[[!_displayNavStep(navStep,'problemModel')]]">
            <fieldset>
              <legend>
                Goal States
              </legend>

              <template is="dom-repeat" items="{{problem.goal_states}}" as="item" index-as="objectIndex">
                <div class="listeWorldState">
                  [[item.arg1.name]] is [[_negate(item.negate)]] [[item.name]] [[item.arg2.name]]
                  <paper-button class="delete" on-tap="deletePred" data-args="InitialState">
                    <paper-icon-button icon="delete"></paper-icon-button>
                  </paper-button>
                </div>
              </template>

              <div>
                <paper-dropdown-menu id="menu_instance1_goal_state" label="Instance 1">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newGoalState.arg1}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newGoalState.arg1">
                        [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-radio-button class="button_not" id="button_not_goal_state">not</paper-radio-button>
                <paper-dropdown-menu id="menu_name_goal_state" label="Predicate">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newGoalState.name}}">
                    <template is="dom-repeat" items="[[domain.predicates]]">
                      <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newGoalState.predicate.name">is [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="menu_instance2_goal_state" label="Instance 2">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newGoalState.arg2}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newGoalState.arg2">
                        [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
              <br>
              <paper-button noink class="petit" on-click="addPredicate" data-args="GoalState">+ add new predicate</paper-button>

              <paper-button id="solve" raised class="clear" on-tap="_solve" data-args="">
                Solve Problem
              </paper-button>
            </fieldset>

          </div>

          <!-- ***** Generated Plan **** 3/3 -->
          <div id="plan" hidden$="[[!_displayNavStep(navStep,'generatedPlan')]]">
            <fieldset>
              <legend>
                Generated steps to solve problem
              </legend>
              <p>Verify all sequence is correct before proceeding.</p>
              <p id="noObj">No steps generated</p>
              <table>
                <template is="dom-repeat" items="{{problem.sequence}}" as="item" index-as="stepIndex">
                  <tr>
                    <div id="listSteps">
                      <td>
                        [[stepIndex]]
                      </td>
                      <td>[[_parseArgs(item)]]</td>
                    </div>
                  </tr>
                </template>
              </table>

              <paper-button id="execute" raised class="clear" on-tap="_execute">
                Execute plan
              </paper-button>
            </fieldset>
          </div>
        </div>
        <ros-rviz id="rviz" ros="[[ros]]" hidden$="[[_displayNavStep(navStep,'generatedPlan')]]"></ros-rviz>
      </div>
    </div>
    <paper-dialog id="errorDialog" modal>
      <h2>Error running the program</h2>
      <p>[[error]]</p>
      <div class="buttons">
        <paper-button dialog-confirm class="clear">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="errorNewPrecond">
      <h2>Error creating new initial_state</h2>
      <p id="msgErrorNewPrecond">An error has been encountered ...</p>
      <div class="buttons">
        <paper-button dialog-confirm class="clear">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="errorNewGoalState">
      <h2>Error creating new goal_state</h2>
      <p id="msgErrorNewGoalState">An error has been encountered ...</p>
      <div class="buttons">
        <paper-button dialog-confirm class="clear">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog modal id="loading">
      <p>
        <paper-spinner-lite active></paper-spinner-lite> Waiting for execution</p>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'pbd-new-problem',
      properties: {
        navStep: {
          type: String,
          value: "perception"
        },
        problem: Object,
        domain: Object,
        domain_id: String,
        params: Object,
        planner: {
          type: String,
          value: "ff"
        },
        program: {
          type: Object,
          observer: '_programChanged',
        },
        ros: Object,
        route: Object,
        isRunning: {
          type: Object,
          value: function () {
            return { data: false };
          }
        },
        domainList: {
          type: Object,
          value: function () {
            return { domains: [] };
          }
        },
        pddlDomain: {
          type: Object,
          value: function () {
            return { problems: [] };
          }
        },
        newInitialState: {
          type: Object,
          value: function () {
            return {
              arg1: Object,
              name: '',
              arg2: Object,
              negate: false,
            };
          }
        },
        newGoalState: {
          type: Object,
          value: function () {
            return {
              arg1: Object,
              name: '',
              arg2: Object,
              negate: false,
            };
          }
        },
        problemName: String,
      },

      observers: [
        'load(domain_id, params.*)',
        '_domainUpdated(pddlDomain.*,domainList.*)',
        '_problemUpdated(problem.*)',
        '_checkClearPrecond(newInitialState.name)',
        '_checkClearGoalState(newGoalState.name)',
      ],

      _checkClearPrecond: function (nom_precond) {
        if (nom_precond == "clear") {
          this.$.menu_instance2_precond.disabled = true;
          this.$.menu_instance2_precond.value = undefined;
          this.newInitialState.arg2 = undefined;
        } else {
          this.$.menu_instance2_precond.disabled = false;
        }
      },
      _checkClearGoalState: function (nom_goal_state) {
        if (nom_goal_state == "clear") {
          this.$.menu_instance2_goal_state.disabled = true;
          this.$.menu_instance2_goal_state.value = undefined;
          this.newGoalState.arg2 = undefined;
        } else {
          this.$.menu_instance2_goal_state.disabled = false;
        }
      },
      _problemUpdated: function (problem) {
        if (problem && problem.base && problem.base.name != '') {
          this.problemName = problem.base.name;
        }
      },

      load: function (db_id, paramsChangeRecord) {
        /* if (!db_id) {
                return;
        } */
        if (!this.params.robot) {
          return;
        }
        var depthCloudFrameId = '';
        if (this.params.robot === "pr2") {
          depthCloudFrameId = '/head_mount_kinect_rgb_optical_frame';
        } else if (this.params.robot === "fetch") {
          depthCloudFrameId = '/head_camera_rgb_optical_frame';
        } else if (this.params.robot === "baxter") {
          depthCloudFrameId = '/camera_rgb_optical_frame';
        } else {
          console.error('Unknown robot type', this.params.robot);
        }

        var fixedFrame = '';
        if (this.params.robot === "pr2" || this.params.robot === "fetch") {
          fixedFrame = '/base_link';
        } else if (this.params.robot === "baxter") {
          fixedFrame = '/base';
        } else {
          console.error('Unknown robot type', this.params.robot);
        }
        if (this.problem) {
          db_id = this.problem.generated_plan;
        }
        var config = {
          globalOptions: {
            background: '#113344',
            colladaLoader: 'collada2',
            colladaServer: window.location.protocol + '//' + window.location.hostname + ':8001/',
            fixedFrame: fixedFrame,
            videoServer: window.location.protocol + '//' + window.location.hostname + ':9998',
            url: 'ws://' + window.location.hostname + ':9090'
          },
          displays: [
            {
              isShown: true,
              name: 'Grid',
              type: 'grid',
              options: {
                cellSize: 1,
                color: '#cccccc',
                numCells: 20,
              },
            }, {
              isShown: false,
              name: 'Program robot model',
              type: 'markerArray',
              options: {
                topic: '/rapid_pbd/robot/' + db_id,
              },
            }, {
              isShown: true,
              name: 'Scene',
              type: 'pointCloud2',
              options: {
                size: 0.01,
                topic: '/rapid_pbd/scene/' + db_id,
              },
            }, {
              isShown: true,
              name: 'Surface segmentation',
              type: 'markers',
              options: {
                topic: '/rapid_pbd/surface_seg/visualization/'// + db_id,
              },
            }, {/* 
                                                        isShown: true,
                                                        name: 'Surface segmentation',
                                                        type: 'markerArray',
                                                        options: {
                                                                topic: '/rapid_pbd/surface_segmentation/' + db_id,
                                                        },
                                                }, { */
              isShown: true,
              name: 'Current robot model',
              type: 'urdf',
              options: {
                param: 'robot_description',
                tfPrefix: ''
              },
            }, {
              isShown: false,
              name: 'Current surface segmentation',
              type: 'markerArray',
              options: {
                topic: '/rapid_pbd/runtime_segmentation',
              },
            }, {
              isShown: false,
              name: 'Current depth cloud',
              type: 'depthCloud',
              options: {
                topic: 'depthcloud_encoded',
                frameId: depthCloudFrameId
              },
            },
          ],
          sidebarOpened: false,
        };
        if (this.$.rviz) {
          this.$.rviz.config = config;
        } else {
          console.info('rviz not ready');
        }

      },

      _updatePredicate: function (evt) {
        var args = evt.target.getAttribute('data-args');
        this.set(args, evt.target.name);
        console.debug(args, ' is ', this.newInitialState);
      },
      checkPredicate: function (mode, _new) {
        var newPredicate = _new;
        var valide = true;
        var index = 0;
        // msgErreur explains why the precond isn't valid
        var msgErreur = "";

        if (mode == "initial_state") {
          var liste = this.problem.initial_states;
          // Check if items are well selected
          if (this.$.menu_instance1_precond.value == undefined || this.$.menu_name_precond.value == undefined || (this.$.menu_name_precond.value != "is clear" && this.$.menu_instance2_precond.value == undefined)) {
            valide = false;
            msgErreur = "Complete your new predicate before adding it";
          }
        } else {
          var liste = this.problem.goal_states;
          // Check if items are well selected
          if (this.$.menu_instance1_goal_state.value == undefined || this.$.menu_name_goal_state.value == undefined || (this.$.menu_name_goal_state.value != "is clear" && this.$.menu_instance2_goal_state.value == undefined)) {
            valide = false;
            msgErreur = "Complete your new predicate before adding it";
          }
        }

        if (valide) {
          // Without negation
          if (!newPredicate.negate) {
            // To comment when you want to test else it's impossible to test on simulation                            
            if (newPredicate.arg1.type.name == "position" && newPredicate.name == "on") {
              valide = false;
              msgErreur = "A position can't be on something else"
            }
            else if (newPredicate.name == "on" && newPredicate.arg1.name == newPredicate.arg2.name) {
              valide = false;
              msgErreur = "An element can't be set on himself";
            }

            while (valide && index < liste.length) {
              if (newPredicate.name == "clear" && liste[index].name == "clear" && newPredicate.arg1.name == liste[index].arg1.name) {
                valide = false;
                msgErreur = "This " + mode + " exists already";
              }
              else if (newPredicate.name == liste[index].name && newPredicate.arg1.name == liste[index].arg1.name && newPredicate.arg2.name == liste[index].arg2.name) {
                valide = false;
                msgErreur = "This " + mode + " exists already";
              }
              else if (newPredicate.name == "on" && liste[index].name == "on") {
                if (newPredicate.arg2.name == liste[index].arg2.name) {
                  valide = false;
                  msgErreur = "You can't place two objects on one position, see :<br><strong>" + liste[index].arg1.name + liste[index].name + liste[index].arg2.name + "</strong>";
                } else if (newPredicate.arg1.name == liste[index].arg1.name) {
                  valide = false;
                  msgErreur = "One object can't be on two positions, see :<br><strong>" + liste[index].arg1.name + liste[index].name + " " + liste[index].arg2.name + "</strong>";
                }
              }
              else if (newPredicate.name == "clear" && (liste[index].name == "on" && liste[index].arg2.name == newPredicate.arg1.name)) {
                valide = false;
                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + "is " + liste[index].name + " " + liste[index].arg2.name + "</strong>";
              }
              else if (liste[index].name == "clear" && (newPredicate.name == "on" && newPredicate.arg2.name == liste[index].arg1.name)) {
                valide = false;
                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + " is " + liste[index].name + "</strong>";
              }
              index++;
            }
            // With negation
          } else {

          }
        }
        return { valid: valide, msg: msgErreur };
      },
      addPredicate: function (evt) {
        var condition = evt.target.getAttribute('data-args');
        if (condition == "InitialState") {
          // Check if the NOT-button is checked or no and update it
          this.newInitialState.negate = this.$.button_not_precond.checked;
          this.$.button_not_precond.checked = false;

          var check = this.checkPredicate("initial_state", this.newInitialState);
          if (check.valid) {
            // We recreate the this.newInitialState object, else it's passed by reference and it causes problems
            this.problem.initial_states.push({ arg1: this.newInitialState.arg1, name: this.newInitialState.name, arg2: this.newInitialState.arg2, negate: this.newInitialState.negate });
            this.reevaluateArray('problem.initial_states', this.problem.initial_states);
          } else {
            this.$.msgErrorNewPrecond.innerHTML = check.msg;
            this.$.errorNewPrecond.open();
          }
        } else if (condition == "GoalState") {
          // Check if the NOT-button is checked or no and update it
          this.newGoalState.negate = this.$.button_not_goal_state.checked;
          this.$.button_not_goal_state.checked = false;

          var check = this.checkPredicate("goal_state", this.newGoalState);
          if (check.valid) {
            this.problem.goal_states.push({ arg1: this.newGoalState.arg1, name: this.newGoalState.name, arg2: this.newGoalState.arg2, negate: this.newGoalState.negate });
            this.reevaluateArray('problem.goal_states', this.problem.goal_states);
          } else {
            this.$.msgErrorNewGoalState.innerHTML = check.msg;
            this.$.errorNewGoalState.open();
          }
        }
      },
      deletePred: function (evt) {
        var item = evt.model.item;
        console.debug('deletePred', item);
        var index = -1;
        index = this.problem.initial_states.indexOf(item);
        if (index != -1) {
          this.splice('problem.initial_states', index, 1, );
          this.reevaluateArray('problem.initial_states', this.problem.initial_states);
          console.debug('deletePred from pre');
        } else {
          index = this.problem.goal_states.indexOf(item);
          if (index != -1) {
            this.splice('problem.goal_states', index, 1, );
            this.reevaluateArray('problem.goal_states', this.problem.goal_states);
            console.debug('deletePred from eff');
          }
        }
      },

      reevaluateArray: function (name, property) {
        var conds = property;
        this.set(name, []);
        this.set(name, conds);
      },
      _nameValid: function (name) {
        for (var i = 0; i < this.domain.problems.length; ++i) {
          if (this.domain.problems[i].name == name) return false;
        }
        return true;
      },

      _updateDomain: function (evt) {
        var msg = {
          type: 'update pddl domain',
          domain_id: this.domain_id,
          pddl_domain: this.domain
        };
        this.$.eventPub.publish(msg);
      },

      _domainUpdated: function (changedDomain, changedList) {
        if (changedDomain.value) {
          this.$.loading.close();
          this.domain = changedDomain.value;
          //updating the current problem
          var j = 0;
          while (j < this.domain.problems.length && this.domain.problems[j].name != this.problem.name) {
            j++;
          }
          if (j != this.domain.problems.length) {
            this.problem = this.domain.problems[j];
          }
          //show if no objects have been detected
          var i = 0;
          while (i < this.problem.objects.length && this.problem.objects[i].type.name == "position") {
            i++;
          }
          if (i != this.problem.objects.length) {
            this.$.noObj.style.display = "none";
          }
        }
        if (this.domainList && this.domainList.domains.length == 1) {
          this.domain_id = this.domainList.domains[0].domain_id;
        }
      },


      _solve: function (evt) {
        console.debug("Solve problem ", this.problem);
        var msg = {
          type: 'solve pddl problem',
          domain_id: this.domain_id,
          planner: this.planner,
          pddl_problem: this.problem
        };
        this.$.eventPub.publish(msg);
        this.navStep = 'generatedPlan';
      },
      _execute: function (evt) {
        console.debug("Execute plan..", this.problem.generated_plan);

        var msg = {
          type: 'run pddl plan',
          domain_id: this.domain_id,
          planner: this.planner,
          pddl_problem: this.problem,
          state_name: ''
        };
        this.$.eventPub.publish(msg);
      },
      _detect: function (evt) {
        if (!this.ros) {
          console.error('Unable to call detection right now.');
          return;
        }
        var state = evt.target.getAttribute('data-args');
        var msg = {
          type: 'detect world state',
          domain_id: this.domain_id,
          problem_name: this.problem.name,
          state_name: state
        };
        console.debug(msg);
        this.$.loading.open();
        this.$.eventPub.publish(msg);
      },
      removeDuplicates: function (a) {
        uniqueArray = a.filter(function (item, pos) {
          return a.indexOf(item) == pos;
        });
      },
      _getName: function (all_types) {

        var names = ['-'];
        if (all_types) {
          for (var i = 0; i < all_types.length; ++i) {
            names.push(all_types[i].name);
          }
        }
        return this.removeDuplicates(names);
      },

      _getTypes: function (item) {
        var names = [];
        //console.debug('_getTypes: ', item);

        if (item) {
          names.push(item.type.name);
          if (item.type.parent != '')
            names.push(item.type.parent);
        }
        return (names);
      },
      // _getType: function (all_types) {
      //   var names = ['-'];
      //   console.debug('_getType: ', all_types);

      //   if (all_types) {
      //     for (var i = 0; i < all_types.length; ++i) {
      //       names.push(all_types[i].type.name);
      //     }
      //   }
      //   return this.removeDuplicates(names);
      // },
      sortByName: function (arr) {
        arr.sort(function (a, b) {
          if (a.name < b.name) return -1;
          if (a.name > b.name) return 1;
          return 0;
        });
        return arr;
      },
      _parseArgs: function (step) {
        // translates string array to "english"
        console.debug("_parseArgs: ", step);
        if (step.args.length == 0) return step.action;
        if (step.args.length == 1) return step.args[0] + ": " + step.action;
        if (step.args.length == 2) return step.action + ": " + step.args[0] + " to " + step.args[1];
        if (step.args.length == 3) return step.action + ": " + step.args[0] + " from " + step.args[1] + " to " + step.args[2];
        return step.action + "(" + step.args.join() + ")";
      },
      _displayNavStep: function (navStep, name) {
        return (navStep == name);
      },
      _selectNavStep: function (evt) {
        this.navStep = evt.target.getAttribute('data-args');
      },
      _negate: function (neg) {
        if (neg) return 'not ';
        else return '';
      },
      save: function () {
        if (this.problemName != this.problem.name && !this._nameValid(this.problemName)) {
          alert(this.problemName + ' already exists. Please choose a different name.');
        } else {
          var msg = {
            type: 'update pddl problem',
            domain_id: this.domain_id,
            problem_name: this.problemName,
            pddl_problem: this.problem
          };

          console.debug('Saving ', this.domain, " with name ", this.domain_id);
          console.debug('Saving ', this.problem, " with name ", this.problemName);
          this.$.eventPub.publish(msg);
          this.quit();
        }

      },
      quit: function (evt) {
        this.fire('quit');
      },
      saving: function (evt) {
        this.$.saving.open();
      },
      exiting: function (evt) {
        this.$.exiting.open();
      }
    });
  </script>